#!/usr/bin/env bash

# Copyright (C) 2018-Present Pivotal Software, Inc. All rights reserved.
#
# This program and the accompanying materials are made available under the terms of the under the Apache License,
# Version 2.0 (the "Licenseâ€); you may not use this file except in compliance with the License. You may obtain a copy
# of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
# an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
# specific language governing permissions and limitations under the License.

set -euo pipefail

bin_dir='app/bin'
lib_dir='app/lib'

function install_mysql_client_utils() {
    mkdir -p /build
    cd "/build"

    local source_directory build_cache_digest="" source_digest=""

    source_directory=$(readlink -f /usr/local/src/percona-server-*/)
    source_digest=$(sha256sum "${source_directory}/MYSQL_VERSION" | awk '{print $1}')
    if [[ -f VERSION.dep ]];then
      build_cache_digest=$(sha256sum VERSION.dep | awk '{print $1}')
    fi

    if [[ "${build_cache_digest}" != "${source_digest}" ]];then
      echo >&2 '!!! Detected stale build cache for Percona Server. Invalidating cache. !!!'
      echo >&2 "/build/VERSION.dep (digest: ${build_cache_digest}) != ${source_directory}/MYSQL_VERSION (digest: ${source_digest})"
      rm -fr ./*
    else
      echo >&2 "Re-using existing build cache in /build"
      echo >&2
    fi

    CMAKE_INCLUDE_PATH=/usr/include/ cmake /usr/local/src/percona-server-*/ \
      -DBUILD_CONFIG=mysql_release \
      -DCMAKE_BUILD_TYPE=RelWithDebInfo \
      -DCMAKE_INSTALL_PREFIX=/build \
      -DFEATURE_SET=community \
      -DINSTALL_MYSQLTESTDIR= \
      -DWITH_BOOST=/usr/local/src/boost_1_59_0/ \
      -DWITH_EMBEDDED_SERVER=OFF \
      -DWITH_EDITLINE=bundled \
      -DWITH_SSL=system \
      -DWITH_ZLIB=system \
      -DIGNORE_AIO_CHECK=ON \
      -DWITHOUT_SERVER=ON && \
      make --jobs 4 && \
      make install
    cd -

    mv /build/LICENSE "${bin_dir}"
    mv /build/README "${bin_dir}"
    mv /build/bin/mysql "${bin_dir}"
    mv /build/bin/mysqldump "${bin_dir}"
    cp /usr/lib/x86_64-linux-gnu/libssl.so.1.1 ${lib_dir}
    cp /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1 ${lib_dir}
    cp /lib/x86_64-linux-gnu/libtinfo.so.5 ${lib_dir}
}

function install_migrate_task() {
    GOBIN="$PWD/app/bin" go install github.com/pivotal-cf/mysql-cli-plugin/tasks/migrate
}

function clean_app_directory() {
    rm -rf ${bin_dir}
    rm -rf ${lib_dir}
    mkdir -p ${bin_dir}
    mkdir -p ${lib_dir}
}

function main() {
    >&2 echo "Cleaning app/ directory..."
    clean_app_directory
    >&2 echo "Installing migrate task binary into app/"
    install_migrate_task
    >&2 echo "Installing mysql client utilities into app/"
    install_mysql_client_utils
}

main
